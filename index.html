<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Scanner de C√≥digos de Barras Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .main-content {
      padding: 30px;
    }

    .scanner-section {
      text-align: center;
      margin-bottom: 30px;
    }

    #scanner-container {
      width: 100%;
      max-width: 400px;
      height: 300px;
      margin: 20px auto;
      border: 3px solid #4CAF50;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      background: #f5f5f5;
    }

    #scanner-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 100px;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      pointer-events: none;
    }

    .scanner-overlay::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 2px solid rgba(76, 175, 80, 0.3);
      border-radius: 10px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .btn-primary { background: #4CAF50; color: white; }
    .btn-secondary { background: #2196F3; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-success { background: #4CAF50; color: white; }

    .status {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      font-weight: 500;
    }

    .status.success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
    .status.error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
    .status.info { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }

    .memo-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
    }

    .memo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .memo-header h3 {
      color: #333;
      font-size: 1.3em;
    }

    .memo-stats {
      font-size: 0.9em;
      color: #666;
      background: white;
      padding: 8px 15px;
      border-radius: 20px;
    }

    #memo-content {
      width: 100%;
      min-height: 200px;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      background: white;
      resize: vertical;
    }

    #memo-content:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
    }

    .memo-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .whatsapp-section {
      background: #e8f5e8;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
    }

    .whatsapp-section h3 {
      color: #2e7d32;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #whatsapp-number {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    #whatsapp-number:focus {
      border-color: #4CAF50;
      outline: none;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    .toast.info { background: #2196F3; }

    .quantity-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .quantity-modal.show {
      display: flex;
    }

    .quantity-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .quantity-content h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.4em;
    }

    .code-display {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 1.1em;
      color: #2e7d32;
      font-weight: bold;
    }

    .quantity-input {
      width: 100px;
      padding: 15px;
      font-size: 1.2em;
      text-align: center;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      margin: 15px 0;
    }

    .quantity-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .camera-settings {
      background: #f0f8ff;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .camera-settings h4 {
      color: #1565c0;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .camera-controls label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      color: #333;
    }

    .camera-controls input[type="range"] {
      width: 100px;
    }

    .camera-controls select {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    @media (max-width: 768px) {
      .container { margin: 10px; }
      .main-content { padding: 20px; }
      .controls { justify-content: center; }
      .btn { padding: 10px 20px; font-size: 14px; }
      .quantity-content { padding: 20px; }
      .camera-controls { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì± Scanner Pro</h1>
      <p>Escaneie c√≥digos de barras com facilidade</p>
    </div>

    <div class="main-content">
      <div class="scanner-section">
        <div class="camera-settings">
          <h4>‚öôÔ∏è Configura√ß√µes da C√¢mera</h4>
          <div class="camera-controls">
            <label>
              üìê Resolu√ß√£o:
              <select id="resolution-select">
                <option value="640x480">640x480 (Padr√£o)</option>
                <option value="1280x720" selected>1280x720 (HD)</option>
                <option value="1920x1080">1920x1080 (Full HD)</option>
              </select>
            </label>
            <label>
              üîç Zoom:
              <input type="range" id="zoom-range" min="1" max="3" step="0.1" value="1">
              <span id="zoom-value">1.0x</span>
            </label>
            <label>
              ‚ö° Flash:
              <button class="btn btn-secondary" id="flash-toggle" style="padding: 5px 10px; margin: 0;">üí° OFF</button>
            </label>
            <label>
              üéØ Foco:
              <button class="btn btn-secondary" id="focus-btn" style="padding: 5px 10px; margin: 0;">üîÑ Auto</button>
            </label>
          </div>
        </div>

        <div id="scanner-container">
          <div class="scanner-overlay"></div>
        </div>
        
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Inicializando c√¢mera...</p>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="controls">
          <button class="btn btn-primary" id="start-scan">üéØ Iniciar Scanner</button>
          <button class="btn btn-warning" id="switch-camera">üîÑ Trocar C√¢mera</button>
          <button class="btn btn-danger" id="stop-scan" style="display: none;">‚èπÔ∏è Parar</button>
        </div>
      </div>

      <div class="memo-section">
        <div class="memo-header">
          <h3>üìù C√≥digos Escaneados</h3>
          <div class="memo-stats">
            Total: <span id="code-count">0</span> c√≥digos
          </div>
        </div>
        
        <textarea id="memo-content" placeholder="Os c√≥digos escaneados aparecer√£o aqui..."></textarea>
        
        <div class="memo-actions">
          <button class="btn btn-success" id="copy-memo">üìã Copiar Tudo</button>
          <button class="btn btn-secondary" id="download-memo">üíæ Baixar</button>
          <button class="btn btn-danger" id="clear-memo">üóëÔ∏è Limpar</button>
          <button class="btn btn-warning" id="export-json">üìä Exportar JSON</button>
        </div>
      </div>

      <div class="whatsapp-section">
        <h3>üí¨ Enviar para WhatsApp</h3>
        <input type="tel" id="whatsapp-number" placeholder="Ex: 5562999887766 (DDI + DDD + n√∫mero)">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-success" id="whatsapp-last">üì± Enviar √öltimo</button>
          <button class="btn btn-success" id="whatsapp-all">üì± Enviar Todos</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Quantidade -->
  <div class="quantity-modal" id="quantity-modal">
    <div class="quantity-content">
      <h3>üì± C√≥digo Detectado!</h3>
      <div class="code-display" id="detected-code"></div>
      <p>Informe a quantidade:</p>
      <input type="number" class="quantity-input" id="quantity-input" value="1" min="1" max="9999">
      <div class="quantity-buttons">
        <button class="btn btn-success" id="confirm-quantity">‚úÖ Confirmar</button>
        <button class="btn btn-danger" id="cancel-quantity">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    class BarcodeScanner {
      constructor() {
        this.isScanning = false;
        this.usingFrontCamera = false;
        this.scannedCodes = [];
        this.lastScannedCode = null;
        this.currentStream = null;
        this.currentTrack = null;
        this.cameraSettings = {
          resolution: { width: 1280, height: 720 },
          zoom: 1.0,
          flashEnabled: false,
          focusMode: 'continuous'
        };
        this.pendingCode = null;
        this.initializeElements();
        this.attachEventListeners();
        this.loadSavedData();
      }

      initializeElements() {
        this.elements = {
          scannerContainer: document.getElementById('scanner-container'),
          loading: document.getElementById('loading'),
          status: document.getElementById('status'),
          startBtn: document.getElementById('start-scan'),
          stopBtn: document.getElementById('stop-scan'),
          switchBtn: document.getElementById('switch-camera'),
          memoContent: document.getElementById('memo-content'),
          codeCount: document.getElementById('code-count'),
          copyBtn: document.getElementById('copy-memo'),
          downloadBtn: document.getElementById('download-memo'),
          clearBtn: document.getElementById('clear-memo'),
          exportBtn: document.getElementById('export-json'),
          whatsappNumber: document.getElementById('whatsapp-number'),
          whatsappLastBtn: document.getElementById('whatsapp-last'),
          whatsappAllBtn: document.getElementById('whatsapp-all'),
          // Novos elementos
          quantityModal: document.getElementById('quantity-modal'),
          detectedCode: document.getElementById('detected-code'),
          quantityInput: document.getElementById('quantity-input'),
          confirmQuantityBtn: document.getElementById('confirm-quantity'),
          cancelQuantityBtn: document.getElementById('cancel-quantity'),
          resolutionSelect: document.getElementById('resolution-select'),
          zoomRange: document.getElementById('zoom-range'),
          zoomValue: document.getElementById('zoom-value'),
          flashToggle: document.getElementById('flash-toggle'),
          focusBtn: document.getElementById('focus-btn')
        };
      }

      attachEventListeners() {
        this.elements.startBtn.addEventListener('click', () => this.startScanner());
        this.elements.stopBtn.addEventListener('click', () => this.stopScanner());
        this.elements.switchBtn.addEventListener('click', () => this.switchCamera());
        this.elements.copyBtn.addEventListener('click', () => this.copyToClipboard());
        this.elements.downloadBtn.addEventListener('click', () => this.downloadMemo());
        this.elements.clearBtn.addEventListener('click', () => this.clearMemo());
        this.elements.exportBtn.addEventListener('click', () => this.exportJSON());
        this.elements.whatsappLastBtn.addEventListener('click', () => this.sendToWhatsApp('last'));
        this.elements.whatsappAllBtn.addEventListener('click', () => this.sendToWhatsApp('all'));
        
        // Auto-save memo content
        this.elements.memoContent.addEventListener('input', () => this.saveData());
        this.elements.whatsappNumber.addEventListener('input', () => this.saveData());
        
        // Novos event listeners
        this.elements.confirmQuantityBtn.addEventListener('click', () => this.confirmQuantity());
        this.elements.cancelQuantityBtn.addEventListener('click', () => this.cancelQuantity());
        this.elements.resolutionSelect.addEventListener('change', () => this.updateResolution());
        this.elements.zoomRange.addEventListener('input', () => this.updateZoom());
        this.elements.flashToggle.addEventListener('click', () => this.toggleFlash());
        this.elements.focusBtn.addEventListener('click', () => this.focusCamera());
        
        // Enter key no input de quantidade
        this.elements.quantityInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.confirmQuantity();
        });
        
        // ESC key para cancelar modal
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.elements.quantityModal.classList.contains('show')) {
            this.cancelQuantity();
          }
        });
      }

      showLoading(show = true) {
        this.elements.loading.style.display = show ? 'block' : 'none';
      }

      showStatus(message, type = 'info') {
        this.elements.status.textContent = message;
        this.elements.status.className = `status ${type}`;
        this.elements.status.style.display = 'block';
        
        setTimeout(() => {
          this.elements.status.style.display = 'none';
        }, 5000);
      }

      showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      async startScanner() {
        if (this.isScanning) return;
        
        this.showLoading(true);
        this.elements.startBtn.style.display = 'none';
        this.elements.stopBtn.style.display = 'inline-flex';
        
        try {
          await this.initializeQuagga();
          this.isScanning = true;
          this.showLoading(false);
          this.showStatus('üì∑ Scanner ativo - Posicione o c√≥digo de barras no quadro', 'success');
        } catch (error) {
          this.showLoading(false);
          this.showStatus('‚ùå Erro ao inicializar c√¢mera: ' + error.message, 'error');
          this.elements.startBtn.style.display = 'inline-flex';
          this.elements.stopBtn.style.display = 'none';
        }
      }

      stopScanner() {
        if (!this.isScanning) return;
        
        if (typeof Quagga !== 'undefined') {
          Quagga.stop();
        }
        this.isScanning = false;
        this.elements.startBtn.style.display = 'inline-flex';
        this.elements.stopBtn.style.display = 'none';
        this.showStatus('‚èπÔ∏è Scanner parado', 'info');
      }

      switchCamera() {
        if (this.isScanning) {
          this.usingFrontCamera = !this.usingFrontCamera;
          this.stopScanner();
          setTimeout(() => this.startScanner(), 500);
        } else {
          this.usingFrontCamera = !this.usingFrontCamera;
          this.showToast(`C√¢mera ${this.usingFrontCamera ? 'frontal' : 'traseira'} selecionada`, 'info');
        }
      }

      async initializeQuagga() {
        const resolution = this.elements.resolutionSelect.value.split('x');
        const width = parseInt(resolution[0]);
        const height = parseInt(resolution[1]);
        
        return new Promise((resolve, reject) => {
          Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: this.elements.scannerContainer,
              constraints: {
                width: width,
                height: height,
                facingMode: this.usingFrontCamera ? "user" : "environment",
                advanced: [
                  {
                    focusMode: this.cameraSettings.focusMode,
                    zoom: this.cameraSettings.zoom
                  }
                ]
              }
            },
            decoder: {
              readers: [
                "ean_reader",
                "ean_8_reader", 
                "code_128_reader",
                "code_39_reader",
                "codabar_reader",
                "i2of5_reader",
                "code_93_reader"
              ],
              debug: {
                drawBoundingBox: true,
                showFrequency: true,
                drawScanline: true,
                showPattern: true
              }
            },
            locator: {
              patchSize: "medium",
              halfSample: true
            },
            locate: true,
            frequency: 15,
            multiple: false
          }, (err) => {
            if (err) {
              reject(err);
              return;
            }
            
            Quagga.start();
            this.setupCameraStream();
            Quagga.onDetected((result) => this.onBarcodeDetected(result));
            resolve();
          });
        });
      }

      async setupCameraStream() {
        try {
          const video = this.elements.scannerContainer.querySelector('video');
          if (video && video.srcObject) {
            this.currentStream = video.srcObject;
            this.currentTrack = this.currentStream.getVideoTracks()[0];
            
            // Aplicar configura√ß√µes da c√¢mera
            if (this.currentTrack) {
              const capabilities = this.currentTrack.getCapabilities();
              const constraints = {};
              
              if (capabilities.zoom && this.cameraSettings.zoom > 1) {
                constraints.zoom = this.cameraSettings.zoom;
              }
              
              if (capabilities.focusMode) {
                constraints.focusMode = this.cameraSettings.focusMode;
              }
              
              if (Object.keys(constraints).length > 0) {
                await this.currentTrack.applyConstraints({ advanced: [constraints] });
              }
            }
          }
        } catch (error) {
          console.warn('Erro ao configurar stream da c√¢mera:', error);
        }
      }

      onBarcodeDetected(result) {
        const code = result.codeResult.code;
        const format = result.codeResult.format;
        
        // Evita c√≥digos duplicados consecutivos
        if (code === this.lastScannedCode) return;
        
        this.lastScannedCode = code;
        this.pendingCode = { code, format };
        
        // Pausa o scanner temporariamente
        if (this.isScanning) {
          Quagga.stop();
          this.isScanning = false;
        }
        
        // Mostra modal de quantidade
        this.showQuantityModal(code, format);
      }

      showQuantityModal(code, format) {
        this.elements.detectedCode.textContent = `${code} (${format})`;
        this.elements.quantityInput.value = 1;
        this.elements.quantityModal.classList.add('show');
        
        // Foca no input de quantidade
        setTimeout(() => {
          this.elements.quantityInput.focus();
          this.elements.quantityInput.select();
        }, 300);
        
        // Som de detec√ß√£o
        this.playDetectionSound();
      }

      confirmQuantity() {
        const quantity = parseInt(this.elements.quantityInput.value) || 1;
        
        if (quantity < 1) {
          this.showToast('‚ùå Quantidade deve ser maior que zero', 'error');
          return;
        }
        
        if (this.pendingCode) {
          const timestamp = new Date().toLocaleString('pt-BR');
          
          const codeEntry = {
            code: this.pendingCode.code,
            format: this.pendingCode.format,
            quantity: quantity,
            timestamp: timestamp
          };
          
          this.scannedCodes.push(codeEntry);
          this.addToMemo(codeEntry);
          this.updateCodeCount();
          this.saveData();
          
          this.showToast(`üì± Adicionado: ${this.pendingCode.code} (${quantity}x)`, 'success');
        }
        
        this.closeQuantityModal();
        
        // Reinicia o scanner ap√≥s 1 segundo
        setTimeout(() => {
          if (!this.isScanning) {
            this.startScanner();
          }
        }, 1000);
      }

      cancelQuantity() {
        this.closeQuantityModal();
        
        // Reinicia o scanner imediatamente
        setTimeout(() => {
          if (!this.isScanning) {
            this.startScanner();
          }
        }, 500);
      }

      closeQuantityModal() {
        this.elements.quantityModal.classList.remove('show');
        this.pendingCode = null;
      }

      playDetectionSound() {
        try {
          // Som mais elaborado de detec√ß√£o
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        } catch(e) {
          console.warn('N√£o foi poss√≠vel reproduzir som');
        }
      }

      addToMemo(codeEntry) {
        const memoText = this.elements.memoContent.value;
        const quantityText = codeEntry.quantity ? ` - Qtd: ${codeEntry.quantity}` : '';
        const newEntry = `[${codeEntry.timestamp}] ${codeEntry.code} (${codeEntry.format})${quantityText}\n`;
        this.elements.memoContent.value = memoText + newEntry;
        this.elements.memoContent.scrollTop = this.elements.memoContent.scrollHeight;
      }

      updateCodeCount() {
        this.elements.codeCount.textContent = this.scannedCodes.length;
      }

      async copyToClipboard() {
        try {
          await navigator.clipboard.writeText(this.elements.memoContent.value);
          this.showToast('üìã Copiado para √°rea de transfer√™ncia!', 'success');
        } catch (err) {
          // Fallback para navegadores mais antigos
          this.elements.memoContent.select();
          document.execCommand('copy');
          this.showToast('üìã Copiado para √°rea de transfer√™ncia!', 'success');
        }
      }

      downloadMemo() {
        const content = this.elements.memoContent.value;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `codigos_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        this.showToast('üíæ Arquivo baixado!', 'success');
      }

      clearMemo() {
        if (confirm('Tem certeza que deseja limpar todos os c√≥digos?')) {
          this.elements.memoContent.value = '';
          this.scannedCodes = [];
          this.updateCodeCount();
          this.saveData();
          this.showToast('üóëÔ∏è Memo limpo!', 'info');
        }
      }

      exportJSON() {
        const data = {
          exportDate: new Date().toISOString(),
          totalCodes: this.scannedCodes.length,
          codes: this.scannedCodes
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `codigos_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        this.showToast('üìä JSON exportado!', 'success');
      }

      sendToWhatsApp(type) {
        const phoneNumber = this.elements.whatsappNumber.value.trim().replace(/\D/g, '');
        
        if (!phoneNumber) {
          this.showToast('‚ùå Digite um n√∫mero de WhatsApp v√°lido', 'error');
          return;
        }

        let message = '';
        
        if (type === 'last' && this.lastScannedCode) {
          message = `C√≥digo de barras: ${this.lastScannedCode}`;
        } else if (type === 'all' && this.scannedCodes.length > 0) {
          message = `C√≥digos de barras escaneados:\n\n${this.elements.memoContent.value}`;
        } else {
          this.showToast('‚ùå Nenhum c√≥digo para enviar', 'error');
          return;
        }

        const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
        this.showToast('üí¨ WhatsApp aberto!', 'success');
      }

      // Novos m√©todos para controle da c√¢mera
      updateResolution() {
        if (this.isScanning) {
          this.stopScanner();
          setTimeout(() => this.startScanner(), 500);
        }
      }

      updateZoom() {
        const zoom = parseFloat(this.elements.zoomRange.value);
        this.elements.zoomValue.textContent = zoom.toFixed(1) + 'x';
        this.cameraSettings.zoom = zoom;
        
        if (this.currentTrack) {
          try {
            this.currentTrack.applyConstraints({
              advanced: [{ zoom: zoom }]
            }).catch(e => console.warn('Zoom n√£o suportado:', e));
          } catch (e) {
            console.warn('Erro ao aplicar zoom:', e);
          }
        }
      }

      async toggleFlash() {
        if (!this.currentTrack) return;
        
        try {
          const capabilities = this.currentTrack.getCapabilities();
          if (capabilities.torch) {
            this.cameraSettings.flashEnabled = !this.cameraSettings.flashEnabled;
            
            await this.currentTrack.applyConstraints({
              advanced: [{ torch: this.cameraSettings.flashEnabled }]
            });
            
            this.elements.flashToggle.textContent = this.cameraSettings.flashEnabled ? 'üí° ON' : 'üí° OFF';
            this.elements.flashToggle.style.backgroundColor = this.cameraSettings.flashEnabled ? '#4CAF50' : '#666';
            
            this.showToast(`üí° Flash ${this.cameraSettings.flashEnabled ? 'ligado' : 'desligado'}`, 'info');
          } else {
            this.showToast('‚ùå Flash n√£o suportado neste dispositivo', 'error');
          }
        } catch (error) {
          this.showToast('‚ùå Erro ao controlar flash', 'error');
          console.warn('Erro no flash:', error);
        }
      }

      async focusCamera() {
        if (!this.currentTrack) return;
        
        try {
          const capabilities = this.currentTrack.getCapabilities();
          if (capabilities.focusMode) {
            // Alterna entre modos de foco
            const currentMode = this.cameraSettings.focusMode;
            const newMode = currentMode === 'continuous' ? 'single-shot' : 'continuous';
            
            await this.currentTrack.applyConstraints({
              advanced: [{ focusMode: newMode }]
            });
            
            this.cameraSettings.focusMode = newMode;
            this.elements.focusBtn.textContent = newMode === 'continuous' ? 'üîÑ Auto' : 'üéØ Manual';
            
            this.showToast(`üéØ Foco: ${newMode === 'continuous' ? 'Autom√°tico' : 'Manual'}`, 'info');
          } else {
            this.showToast('‚ùå Controle de foco n√£o suportado', 'error');
          }
        } catch (error) {
          this.showToast('‚ùå Erro ao ajustar foco', 'error');
          console.warn('Erro no foco:', error);
        }
      }

      saveData() {
        const data = {
          scannedCodes: this.scannedCodes,
          memoContent: this.elements.memoContent.value,
          whatsappNumber: this.elements.whatsappNumber.value,
          lastScannedCode: this.lastScannedCode
        };
        
        try {
          // Simula localStorage usando vari√°vel global
          window.appData = data;
        } catch (e) {
          console.warn('N√£o foi poss√≠vel salvar os dados');
        }
      }

      loadSavedData() {
        try {
          const data = window.appData || {};
          
          if (data.scannedCodes) {
            this.scannedCodes = data.scannedCodes;
            this.updateCodeCount();
          }
          
          if (data.memoContent) {
            this.elements.memoContent.value = data.memoContent;
          }
          
          if (data.whatsappNumber) {
            this.elements.whatsappNumber.value = data.whatsappNumber;
          }
          
          if (data.lastScannedCode) {
            this.lastScannedCode = data.lastScannedCode;
          }
        } catch (e) {
          console.warn('N√£o foi poss√≠vel carregar os dados salvos');
        }
      }
    }

    // Aguarda o carregamento completo da p√°gina
    window.addEventListener('load', function() {
      if (typeof Quagga !== 'undefined') {
        const scanner = new BarcodeScanner();
        console.log('üì± Scanner Pro inicializado com sucesso!');
      } else {
        console.error('‚ùå Biblioteca Quagga n√£o foi carregada');
        document.getElementById('status').innerHTML = '‚ùå Erro ao carregar biblioteca do scanner';
        document.getElementById('status').className = 'status error';
        document.getElementById('status').style.display = 'block';
      }
    });

    // Registrar service worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker registrado'))
        .catch(err => console.warn('‚ö†Ô∏è Erro ao registrar Service Worker:', err));
    }
  </script>
</body>
</html>
